name: Deploy Federated CPT-GPT

on:
  workflow_dispatch: # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install fabrictestbed-extensions pandas pyjwt

      - name: Configure FABRIC Credentials
        run: |
          mkdir -p ~/.fabric
          echo "${{ secrets.FABRIC_TOKEN_JSON }}" > ~/.fabric/id_token.json
          echo "${{ secrets.FABRIC_BASTION_KEY }}" > ~/.fabric/bastion_key
          echo "${{ secrets.FABRIC_SLICE_KEY }}" > ~/.fabric/slice_key
          echo "${{ secrets.FABRIC_SLICE_PUB_KEY }}" > ~/.fabric/slice_key.pub
          chmod 600 ~/.fabric/bastion_key ~/.fabric/slice_key

      - name: Create fabric_rc
        run: |
          cat <<EOF > fabric_rc
          [DEFAULT]
          FABRIC_CREDMGR_HOST=cm.fabric-testbed.net
          FABRIC_ORCHESTRATOR_HOST=orchestrator.fabric-testbed.net
          FABRIC_PROJECT_ID=${{ secrets.FABRIC_PROJECT_ID }}
          FABRIC_TOKEN_LOCATION=/home/runner/.fabric/id_token.json
          FABRIC_BASTION_HOST=bastion.fabric-testbed.net
          FABRIC_BASTION_USERNAME=${{ secrets.FABRIC_BASTION_USERNAME }}
          FABRIC_BASTION_KEY_LOCATION=/home/runner/.fabric/bastion_key
          FABRIC_SLICE_PRIVATE_KEY_FILE=/home/runner/.fabric/slice_key
          FABRIC_SLICE_PUBLIC_KEY_FILE=/home/runner/.fabric/slice_key.pub
          EOF

      - name: Run Deployment
        env:
          FABRIC_LOG_LEVEL: INFO
        run: |
          python fabric_deploy.py

      - name: Upload Artifacts (Logs & Data)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: |
            *.log
            *.csv
            *.png
