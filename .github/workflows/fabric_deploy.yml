name: Deploy to FABRIC

on:
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      FABRIC_CREDMGR_HOST: cm.fabric-testbed.net
      FABRIC_ORCHESTRATOR_HOST: orchestrator.fabric-testbed.net
      FABRIC_PROJECT_ID: ${{ secrets.FABRIC_PROJECT_ID }}
      FABRIC_BASTION_USERNAME: ${{ secrets.FABRIC_BASTION_USERNAME }}
      # We will write these to files in the step
      FABRIC_TOKEN_LOCATION: ${{ github.workspace }}/id_token.json
      FABRIC_BASTION_KEY_LOCATION: ${{ github.workspace }}/bastion_key
      FABRIC_SLICE_PRIVATE_KEY_FILE: ${{ github.workspace }}/slice_key
      FABRIC_SLICE_PUBLIC_KEY_FILE: ${{ github.workspace }}/slice_key.pub

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install fabrictestbed-extensions

      - name: Setup Keys and Tokens
        env:
          FABRIC_TOKEN_JSON: ${{ secrets.FABRIC_TOKEN_JSON }}
        run: |
          # Write JSON token using python to avoid shell quoting issues
          python -c "import os; open(os.environ['FABRIC_TOKEN_LOCATION'], 'w').write(os.environ['FABRIC_TOKEN_JSON'])"

          echo "${{ secrets.FABRIC_BASTION_KEY }}" > $FABRIC_BASTION_KEY_LOCATION
          echo "${{ secrets.FABRIC_SLICE_KEY }}" > $FABRIC_SLICE_PRIVATE_KEY_FILE
          echo "${{ secrets.FABRIC_SLICE_PUB_KEY }}" > $FABRIC_SLICE_PUBLIC_KEY_FILE

          # Set permissions (crucial for SSH keys)
          chmod 600 $FABRIC_TOKEN_LOCATION
          chmod 600 $FABRIC_BASTION_KEY_LOCATION
          chmod 600 $FABRIC_SLICE_PRIVATE_KEY_FILE
          chmod 644 $FABRIC_SLICE_PUBLIC_KEY_FILE

      - name: Run Deployment Script
        run: |
          python fabric_deploy.py
